


# 																data-archiving
## 请求方式/使用方式：
## 1. 订单表-归档接口（JDBC）

> 根据传入的参数来迁移数据，比如传入的是 2024-5-30 17:02:37,那么将会对 2024年4月份的数据进行归档，默认每次归档500条数据，直至归档完成。
>
> 注：此接口第一次调用前先把项目.yml的lastProcessedId值改为被归档的月份的数据的起始id。
> 其他参数可以根据实际情况来选择是否更改。
> 第一次切完表后，往后仍然需要切表的话lastProcessedId值可以不改，因为id值已经被设置为默认自增，但是
> 为了更快的切表，还是建议把lastProcessedId值改为被切分的表的起始id值（缩where条件过滤范围，提升切分效率）。
>
> ```
> # 自定义配置-切表配置（yml文件）
> data-archiving:
>     lastProcessedId: 200000 #  【必填】切表的起始位置，第一次切表先去数据库里面起始位置的id值
>     maxBatchSize: 500 # 【必填】每次切500条数据
>     archiveTablePrefix: order_info # 【必填】切分后的表名称前缀
>     oldTableName: order_info # 【必填】被切分的原始表名称
>     archiveOldSchemaName: inventory_system # 【可选】切分前的表所在的数据库名称，待完善
>     archiveNewSchemaName: inventory_system # 【可选】切后的表所在的数据库名称，待完善
```

### 接口类型：POST

### 接口路径：http://127.0.0.1:8081/archiveDataJDBC/start

### 请求参数示例：

|名称|值|类型|必选|说明|
|---|---|---|---|---|
|dataMonth|2024-5-1 12:23:21|string| 是 |归档的数据所属月份，即对5月份的数据进行归档|

### 成功示例：

```json
{
  月份为：2024-5-1 12:23:21 的归档任务已完成！
}
```

### 失败示例：

```json
{
	错误：无法解析日期 XXXXX，请确保格式正确（格式应为 yyyy-M-d HH:mm:ss）！
}
```

```json
{
    错误：服务器内部错误，归档失败！
}
```

## 2. 订单表-归档接口（MP）

### 接口类型：POST

### 接口路径：http://127.0.0.1:8081/archiveDataMP/start

### 请求参数示例：

|名称|值|类型|必选|说明|
|---|---|---|---|---|
|dataMonth|2024-5-1 12:23:21|string| 是 |归档的数据所属月份，即对5月份的数据进行归档|

### 成功示例：

```json
{
  月份为：2024-5-1 12:23:21 的归档任务已完成！
}
```

### 失败示例：

```json
{
	错误：无法解析日期 XXXXX，请确保格式正确（格式应为 yyyy-M-d HH:mm:ss）！
}
```

```json
{
    错误：服务器内部错误，归档失败！
}
```

## 2. 订单表-查询归档月份数据的起始ID（JDBC）
> 根据传入的参数来查询归档月份的数据起始ID，比如传入的是 2024-5-30 17:02:37,那么将会返回5月份的数据起始ID。

### 接口类型：GET
### 接口路径：http://127.0.0.1:8081/archiveDataMP/getStartIdByMonth/start
### 请求参数示例：
|名称|值|类型|必选|说明|
|---|---|---|---|---|
|dataMonth|2024-5-1 12:23:21|string| 是 |查询归档月份的数据起始ID，即查询5月份的数据起始ID|    
### 成功示例：
```json
{
  id:300001
}
```
### 失败示例：
```json
{
  查询归档月份的数据起始ID失败：XXX
}
```
或者
```json
{
  该月份没有数据，返回起始ID为 null
}
```

## 4. 订单表-查询归档月份数据的数量(MP)
### 接口类型：GET
### 接口路径：http://127.0.0.1:8081/archiveDataMP/getStartIdByMonth/start
### 请求参数示例：
|名称|值|类型|必选|说明|
|---|---|---|---|---|
|dataMonth|2024-5-1 12:23:21|string| 是 |查询归档月份的数据起始ID，即查询5月份的数据起始ID|    
### 成功示例：
```json
{
  id:300001
}
```
### 失败示例：
```json
{
  查询归档月份的数据起始ID失败：XXX
}
```
或者
```json
{
  该月份没有数据，返回起始ID为 null
}
```

## 5. 插入数据接口 （不重要）
> 这个接口不重要，主要是用来想数据库插入实验数据，帮助开发者了解接口的使用。

> 根据请求参数来插，传入的是创建时间是 几月份就生成几月份的数据，默认一次生成10w条。

### 接口类型：GET

### 请求路径： http://127.0.0.1:8081/InsertDatasToOrderInfo/insertByTime

### 请求参数示例：

| 名称       | 值                | 类型   | 必选 | 说明     |
| ---------- | ----------------- | ------ | ---- | -------- |
| createTime | 2024-6-5 22:00:05 | string | 是   | 创建时间 |
| updateTime | 2024-6-5 22:00:05 | string | 是   | 更新时间 |

### 成功示例：

```json
{
    插入10w条数据成功（根据传入的时间戳插入订单数据）
}
```

### 失败示例:

```json
{
  传入的时间戳格式不正确，请重新输入
}
```

### 其他
> 切分后的数据怎么查？
- 1）union all 或者 union，
- 建议加索引在create_time字段上，以便快速查询。
可以先查询2月份-7月份的历史数据，然后再查询X月份未归档数据，最后查询4月份归档数据。
- 2）切表后用视图来查询，给分表后的数据创建视图，然后查询视图即可。

```sql
-- 比如现在（6月份），要查询查询3月份-6月份的历史数据
-- 查询3月份的数据
SELECT * FROM order_info202403
WHERE create_time >= '2024-03-01 00:00:00'
  AND create_time < '2024-03-31 00:00:00'

UNION ALL

-- 查询4月份归档数据
SELECT * FROM order_info202406
WHERE create_time >= '2024-06-01 00:00:00'
  AND create_time < '2024-06-30 00:00:00'

UNION ALL

-- 查询5,6月份未归档数据
SELECT * FROM order_info
WHERE create_time >= '2024-05-01 00:00:00'
  AND create_time < '2024-06-30 00:00:00'
```




